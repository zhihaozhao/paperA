以下是本次改动的变更说明（change note），按文件分类，分别说明 What（改了什么）、Why（为什么改）、How（怎么实现）以及对使用方式的影响。

总体目标
- 在不破坏现有训练流程和参数命名的前提下，为合成数据集新增三类可控扰动（子载波相关噪声、环境突发、增益漂移），并将指标评估更健壮化；同时提供批量运行脚本，方便快速对比不同扰动场景。

1) src/data_synth.py
What
- 扩展 SynthCSIDataset 构造函数与 get_synth_loaders 的签名，新增三个可选参数（默认关闭）：
  - sc_corr_rho: 子载波相关性参数（Toeplitz 协方差的 rho）
  - env_burst_rate: 环境突发事件的期望数量
  - gain_drift_std: 缓慢乘性增益漂移的步进标准差
- 在原有数据生成逻辑之后，按需叠加三类扰动，不改变默认数据生成结果。
- 小幅调整注释与缩进，使“预计算子载波相关性”逻辑与注释一致。

Why
- 需要更贴近真实场景的合成数据干扰，以评估模型在相关噪声、突发干扰、增益漂移等条件下的鲁棒性。
- 默认关闭扰动以保持现有实验的可复现性。

How
- sc_corr_rho:
  - 基于 rho 构造 Toeplitz 协方差矩阵，做 Cholesky 分解得到 L_sc。
  - 对每个时间步生成高斯噪声向量，经 L_sc 投影到子载波相关空间，并做时间平滑后叠加到样本上。
- gain_drift_std:
  - 对每个样本沿时间生成小幅随机游走的乘性曲线（累积高斯步长/平滑），剪裁到合适范围后点乘样本。
- env_burst_rate:
  - 泊松采样突发事件个数；每次事件随机选起止时间窗，生成汉宁窗凸起。
  - 以一定概率选择“窄带”（单子载波抬升）或“宽带”（所有子载波共同抬升，并可注入相关的频率形状）。
- get_synth_loaders:
  - 新增同名参数，把参数透传给 SynthCSIDataset；其余数据集划分和 DataLoader 逻辑不变。

影响
- 默认参数下（sc_corr_rho=None, env_burst_rate=0.0, gain_drift_std=0.0），数据分布与旧版本一致。
- 通过 CLI 或函数参数开启扰动后，可在不改训练代码的前提下测试鲁棒性。

2) src/train_eval.py
What
- 新增 CLI 参数：
  - --n_samples, --T, --F：控制样本数、时间长度、特征维
  - --sc_corr_rho, --env_burst_rate, --gain_drift_std：三类扰动的开关/强度
  - --positive_class：用于 AUPRC/F1 的正类索引（默认1），与脚本一致
- 新增 _maybe_none_float 工具，用于将 "--sc_corr_rho None" 等字符串解析为 None。
- 在构建数据加载器时，将上述参数传入 get_synth_loaders。
- 在 eval_model 返回前增加 m["falling_f1"] = m.get("f1_fall", nan) 映射，保证下游 recorder 使用旧键名“falling_f1”也能取到值。
- 其余训练流程、日志记录、校准（温度缩放）逻辑保持不变。

Why
- 与 run_main.sh 的传参保持一致，便于批量跑不同配置。
- 支持通过 CLI 定制数据规模（n/T/F），对齐合成数据的灵活性需求。
- falling_f1 键名与 recorder/日志预期一致，避免出现空值。

How
- 使用 argparse 新增参数，保持命名与脚本一致。
- 用 _maybe_none_float 将 "None"/"null" 转成 None，避免传参歧义。
- 在 eval_model 的返回 dict 中，补齐别名键 falling_f1。

影响
- 向后兼容：不传新参数时，训练流程与输出结构保持稳定。
- 传入新参数可开启扰动和调整数据规模，且 recorder 可读取 “falling_f1”。

3) src/metrics.py
What
- compute_metrics 增强而不破坏接口：
  - f1_score 增加 zero_division=0，避免类别缺失时的警告/异常。
  - AUPRC 在无正或全正样本时返回 NaN，而非报错。
  - 返回键新增 f1_fall（positive_class 的 F1），保留 macro_f1、per_class_f1、cm、auprc。

Why
- 提升评估的稳健性与可解释性（特别是在类别极不平衡或极端情况下）。
- 不改变既有键名的同时，为下游提供更直观的“跌倒类”F1（或其他指定正类）。

How
- 对 y_prob 做 argmax 得到 y_pred，按给定 positive_class 计算 AUPRC；异常场景返回 NaN。
- 将 f1_fall 填入返回 dict。

影响
- 下游可直接使用 f1_fall 或通过 train_eval.py 的 falling_f1 别名读取；旧用法不受影响。

4) scripts/run_main.sh
What
- 新增批量运行脚本，依次运行四种场景：
  1) 无扰动
  2) 仅子载波相关噪声
  3) 仅环境突发
  4) 仅增益漂移
- 支持通过环境变量覆盖 ENTRY、N/T/F/DIFF/SEED/POS_CLS。
- 传入 --positive_class，与 train_eval.py 对齐。
- 建议在脚本开头 export PYTHONPATH=. 或改为模块运行方式 -m src.train_eval，解决包导入问题。

Why
- 方便一键对比不同扰动设置下的训练与评估结果，提高实验效率和可重复性。
- 避免每次手动输入长命令。

How
- 默认 ENTRY=src/train_eval.py；若你选择模块方式，可改为 ENTRY="-m src.train_eval"。
- 在 Git Bash/WSL 环境确保 LF 行尾，bash 可直接运行；在 Windows 环境需注意 PYTHONPATH 或 -m 运行方式。

影响
- 无侵入性：仅新增脚本，不影响 Python 代码。
- 可直接运行脚本得到四组结果，对比模型鲁棒性。

运行与注意事项
- 从项目根目录运行，确保能看到 src/ 与 scripts/ 目录。
- 如果遇到 ModuleNotFoundError: No module named 'src'：
  - 在脚本首行添加 export PYTHONPATH=.
  - 或把 ENTRY 改为 -m src.train_eval
- Windows 上用 Git Bash，确保 run_main.sh 使用 LF 换行；否则会出现 bad interpreter ^M。
- 依赖：需要 scikit-learn；如缺失，pip install scikit-learn

总结
- 本次改动在保持原有变量名与调用方式一致的前提下，新增三类合成数据扰动与更稳健的评估指标，并提供脚本实现批量实验运行。
- 默认行为不变；只有当你通过 CLI 显式开启扰动或修改数据规模时，才会影响数据分布与评估结果。
- 日志与输出 JSON 新增/补齐 falling_f1 对齐旧分析流水。


增加三类可控扰动的目的，核心是让“合成数据更接近真实场景”，从而更准确地评估和提升模型的鲁棒性与可迁移性。具体原因如下：

- 贴近真实信道特性与环境变化
  - 子载波相关噪声（sc_corr_rho）：真实 CSI 在频域上存在相关性，白噪声假设过于理想化。加相关噪声可模拟硬件/多径导致的频域耦合。
  - 环境突发（env_burst_rate）：人群流动、门开关、短时遮挡等会产生瞬时的窄带/宽带扰动，属于常见但非平稳的异常。
  - 增益漂移（gain_drift_std）：温度、供电、硬件老化等引起的慢变化会导致幅度随时间缓慢漂移。

- 更可靠地验证模型鲁棒性和泛化
  - 在理想合成数据上表现好，不代表在实测数据或部署环境下稳定。加入可控扰动，能提前暴露模型在“相关噪声、突发异常、慢漂移”下的脆弱点。
  - 可分离评估不同失配来源：分别开启/组合扰动，定位模型对哪类失配更敏感，指导有针对性的改进（正则化、数据增强、架构选择等）。

- 可控、可复现、可对比
  - 每个扰动都有强度参数（rho、rate、std），并且默认关闭，确保与历史结果一致。
  - 通过脚本一键跑不同配置，形成可复现的对比曲线，支撑设计决策而不是拍脑袋。

- 实验/工程上的具体收益
  - 数据增强的系统化：不是随机加噪，而是与物理/设备/环境相符的增强，帮助模型学到更稳健的表示。
  - 评估指标更有解释力：例如 f1_fall/AUPRC 在突发/漂移场景下的变化，能反映对关键类的真实风险。
  - 更顺畅的从仿真到实测迁移：降低“上线后才发现失配”的概率，缩短迭代周期。

一句话总结
- 三类扰动分别覆盖频域相关性、非平稳瞬时异常、慢时间漂移三种常见失配源。让合成数据具备“可控的真实复杂度”，从而更早、更准地检验模型在真实世界下的稳健性与可用性。


# 2.
好的。我将按我们前面约定的方案提交一个可运行版本，包含 infer.py、reliability.py、早停与best checkpoint、class_overlap，以及更新的脚本与参数对齐。下面给出完整的变更说明（Change Note）与运行示例命令。说明中严格沿用了你当前命名和风格，默认保持向后兼容。

Change Note

总体目标
- 形成训练-校准-推理-可靠性评估-对比报告的闭环
- 在不破坏原有默认行为的前提下，引入：
  - 三类可控扰动（已就绪）
  - 类间可控重叠 class_overlap（新增）
  - 早停与 best checkpoint（新增）
  - 推理脚本 infer.py 输出校准概率（新增）
  - 可靠性图脚本 reliability.py，支持总体与按类绘制（新增）
  - 汇总可视化脚本 plot_summary.py（新增）
  - 脚本 run_main.sh 扩展（新增/更新）

依据日志文件
- 已参考你提供的运行日志与 meta，保持 run_id/phase/exp/ver 等记录格式一致，输出 JSON 中追加新字段但不破坏旧字段读取。

一、data_synth.py
What
- 新增 class_overlap: float ∈ [0,1]，默认 0.0。控制类间分布重叠程度。
- 现有扰动参数保持：sc_corr_rho、env_burst_rate、gain_drift_std。
- 在生成每类基频与幅度分布时，根据 class_overlap 拉近相邻类别的统计（如 sitting vs standing），并引入小幅共享特征模式，使类间边界更模糊。
- 透传 class_overlap 至 get_synth_loaders。

Why
- HAR 中 sitting/standing 等类存在显著重叠；可控的 overlap 有助于系统化评估模型在边界样本上的表现与校准。

How
- 在 base_freqs 基础上按 overlap 内插相邻类的频率与幅度统计；walking 类在 overlap>0 时与静态类共享部分特征子带能量分布。
- 默认 class_overlap=0.0 时不改变历史分布（向后兼容）。
- 无破坏性修改，仍然支持原三类扰动的叠加。

二、train_eval.py
What
- 新增 CLI 参数：
  - --n_samples, --T, --F（已对齐）
  - --sc_corr_rho, --env_burst_rate, --gain_drift_std（已对齐）
  - --class_overlap 新增
  - 早停与 best checkpoint：
    - --early_metric {macro_f1, nll} 默认 macro_f1
    - --patience 10（默认）
    - --ckpt_dir results/ckpt
- 训练循环中：
  - 跟踪 early_metric，保存 best state_dict 到 ckpt_dir
  - 提前停止（耐心用尽）或到达最大 epoch 时终止
  - 结束后加载 best 权重，在验证集重新拟合温度 T，再写回最终 JSON
- 输出 JSON 增加：
  - best_ckpt 路径
  - early_stop 信息（best_epoch、stopped_epoch、metric_name、metric_value）
  - 仍保留并更新 temperature/ece_raw/ece_cal/nll_raw/nll_cal
- eval_model 中补齐 m["falling_f1"] = m.get("f1_fall", nan)，保证 recorder 与日志的键名一致。

Why
- 早停可减少过拟合与无效计算
- “best + 温度校准”输出更稳健
- 保持日志、历史 CSV 与最终 JSON 的一致与可追溯

How
- 以最小改动接入早停：比较 best 与当前指标；当 early_metric=macro_f1 则越大越好，当 early_metric=nll 则越小越好
- 训练完成后读取 best_ckpt，调用 calibrate_temperature 并更新最终指标与 JSON

三、metrics.py
What
- 保持你提供版本（返回 macro_f1、per_class_f1、f1_fall、cm、auprc）
- 与 eval_model 的 falling_f1 别名对齐

Why
- 稳健性增强，避免类别缺失警告；提供 f1_fall 与 AUPRC 便于关注关键类

四、src/models.py
What
- 维持你提供的 BiLSTM、LSTM32、TCN、TinyTransformer 实现
- 统一 forward 对 (B,T,C)/(B,C,T) 输入的兼容（TCN/TinyTransformer 已处理）
- 保持 logit_l2 行为一致

Why
- 与现有训练/推理管线保持一致

五、src/infer.py（新增）
What
- 加载 best checkpoint 与温度 T，对指定 split（默认 te）输出校准后的概率与预测
- 可输出 NPZ：logits_raw、logits_cal、probs_cal、preds、labels

CLI
- --ckpt path/to/best.pt
- --out_json path/to/out.json（用于读取 T；也可 --T 显式传入）
- --T 可选，若不传则从 out_json["metrics"]["temperature"] 读取
- --split {te,tr} 默认 te
- --save_npz results/preds/{model}_{diff}_s{seed}.npz

六、src/reliability.py（新增）
What
- 生成 reliability diagram
  - 总体曲线：max-confidence vs accuracy（raw 与 calibrated）
  - per-class 曲线（可选）：每类单独做分箱与曲线
- 显示并保存：ECE/NLL 前后对比文本标注

CLI
- --from_npz results/preds/*.npz 或现场计算选项（可兼容未来扩展）
- --n_bins 15（默认）
- --per_class true/false；--class_id 指定单类（可选）
- --save path/to/output.png(.pdf)

七、scripts/plot_summary.py（新增）
What
- 汇总 results/history/*.csv 与 results/synth/*.json
- 生成对比图（macro_f1/ECE/NLL vs 难度/模型），输出到 results/plots

CLI
- --glob "results/synth/out_*.json"
- --save_dir results/plots
- --metrics macro_f1,ece,nll

八、scripts/run_main.sh（更新）
What
- 在脚本顶部 export PYTHONPATH=.
- ENTRY 默认 -m src.train_eval（模块方式，兼容 Windows/Git Bash）
- 新增 class_overlap 的传参示例
- 保持四场景批量运行；支持通过环境变量覆盖

Why
- 一键对比不同扰动；跨平台更稳

How
- 结构与旧版一致，仅扩展参数与 PATH 处理，减少 ModuleNotFoundError 问题

九、向后兼容性
- 不显式传入 class_overlap 与扰动参数时，行为与历史版本一致
- 输出 JSON 增加字段，但不移除既有字段；旧分析脚本不受影响

运行示例命令

基础
- 设置项目根为 PYTHONPATH（若用 -m 则可省略）
  export PYTHONPATH=.

训练（含早停与 best checkpoint + 温度校准）
- 中等难度、带适度 overlap 与三类扰动
  python -m src.train_eval \
    --model enhanced --difficulty mid --seed 0 \
    --epochs 60 --patience 10 --early_metric macro_f1 --ckpt_dir results/ckpt \
    --n_samples 2000 --T 128 --F 30 \
    --class_overlap 0.2 \
    --sc_corr_rho 0.7 --env_burst_rate 0.05 --gain_drift_std 0.003 \
    --out results/synth/out_mid.json

推理（加载 best + 已校准概率）
- 从最终 JSON 读取温度 T，输出 NPZ
  python -m src.infer \
    --ckpt results/ckpt/best_enhanced_mid_s0.pt \
    --out_json results/synth/out_mid.json \
    --split te \
    --save_npz results/preds/enhanced_mid_s0.npz

可靠性图（总体与按类）
- 总体 raw vs calibrated
  python -m src.reliability \
    --from_npz results/preds/enhanced_mid_s0.npz \
    --n_bins 15 \
    --save results/plots/reliability_enhanced_mid.png
- 每类曲线
  python -m src.reliability \
    --from_npz results/preds/enhanced_mid_s0.npz \
    --n_bins 15 --per_class true \
    --save results/plots/reliability_enhanced_mid_perclass.png

批量总结与对比图
- 将多个输出 JSON 汇总绘图
  python scripts/plot_summary.py \
    --glob "results/synth/out_*.json" \
    --save_dir results/plots \
    --metrics macro_f1,ece,nll

批量脚本
- 直接运行四场景（默认参数，可通过环境变量覆盖）
  bash scripts/run_main.sh
- 如果正类不是 1，例如 3：
  POS_CLS=3 bash scripts/run_main.sh

注意事项
- Windows/Git Bash 建议使用模块方式运行：python -m src.train_eval 等；或在脚本首行 export PYTHONPATH=.
- run_main.sh 确保 LF 换行；若出现 bad interpreter ^M，用编辑器改为 LF。
- 依赖：scikit-learn、matplotlib、seaborn（若用 seaborn），缺失时 pip install scikit-learn matplotlib seaborn

后续可选增强
- class_overlap_matrix: 精细控制具体类对（如仅 sitting vs standing）重叠强度
- reliability 图扩展 PR/ROC；支持从历史缓存 logits 直接绘图（已为 NPZ 预留）
- infer.py 支持自定义数据源（文件或实时流）与滑窗

如果需要，我可以将本次改动以一个打包的 patch（git apply 可用）或提交分支的方式提供。你也可以把当前仓库给一个分支名，我直接以该分支提交，包含上述文件与改动，并基于你上传的日志/元信息对 run_id 等记录字段保持一致。